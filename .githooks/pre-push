#!/bin/bash
# OrgOS Pre-Push Hook
# Codexはgit pushを禁止されているが、Claude Code hooksの外で動くため、
# このgit hookでpush事故を防止する。

# カラー出力
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# CONTROL.yaml からフラグを読み取る関数
read_flag() {
    local key="$1"
    local default="$2"
    local control_file=".ai/CONTROL.yaml"

    if [[ ! -f "$control_file" ]]; then
        echo "$default"
        return
    fi

    local value
    value=$(grep -E "^${key}:" "$control_file" | sed 's/.*: *//' | tr -d '"' | tr '[:upper:]' '[:lower:]')

    if [[ "$value" == "true" ]]; then
        echo "true"
    elif [[ "$value" == "false" ]]; then
        echo "false"
    else
        echo "$default"
    fi
}

# リモートとURLを取得
remote="$1"
url="$2"

# mainブランチへのpushかチェック
while read local_ref local_sha remote_ref remote_sha; do
    # main/masterへのpushかチェック
    if [[ "$remote_ref" == "refs/heads/main" ]] || [[ "$remote_ref" == "refs/heads/master" ]]; then
        allow_push_main=$(read_flag "allow_push_main" "false")

        if [[ "$allow_push_main" != "true" ]]; then
            echo -e "${RED}========================================${NC}"
            echo -e "${RED}OrgOS: Push to main/master is BLOCKED${NC}"
            echo -e "${RED}========================================${NC}"
            echo ""
            echo -e "${YELLOW}Reason:${NC} allow_push_main=false in .ai/CONTROL.yaml"
            echo ""
            echo "To allow push to main:"
            echo "  1. Set allow_push_main: true in .ai/CONTROL.yaml"
            echo "  2. Or use Integrator role with Owner approval"
            echo ""
            exit 1
        fi
    else
        # main以外へのpush
        allow_push=$(read_flag "allow_push" "false")

        if [[ "$allow_push" != "true" ]]; then
            echo -e "${RED}========================================${NC}"
            echo -e "${RED}OrgOS: Git push is BLOCKED${NC}"
            echo -e "${RED}========================================${NC}"
            echo ""
            echo -e "${YELLOW}Reason:${NC} allow_push=false in .ai/CONTROL.yaml"
            echo ""
            echo "To allow push:"
            echo "  1. Set allow_push: true in .ai/CONTROL.yaml"
            echo "  2. This requires Owner approval"
            echo ""
            exit 1
        fi
    fi
done

exit 0
