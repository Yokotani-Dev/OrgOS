# セッション管理ルール

> セッション終了提案、コンテキスト管理、継続性の保証

---

## 基本方針

**1セッション1作業を推奨。論理的な区切りでセッションを終了し、台帳で継続性を保証する。**

```yaml
セッション管理の原則:
  - 1セッション1作業（機能単位、ゲート単位）
  - 論理的な区切りでセッション終了を提案
  - コンテキスト使用率は補助的な判断材料
  - 台帳が継続性を保証（セッション間のメモリ）
```

---

## セッション終了を提案するタイミング

### 優先度 P0（必ず提案）

| タイミング | 説明 | 例 |
|------------|------|-----|
| **ゲート通過時** | ステージ遷移が完了した時 | REQUIREMENTS → DESIGN |
| **機能実装完了時** | テスト・レビュー完了後 | 認証機能の実装・テスト・レビューが完了 |
| **統合完了時** | ブランチマージ完了後 | main への統合完了 |
| **リリース完了時** | デプロイ完了後 | 本番環境へのデプロイ完了 |

### 優先度 P1（推奨）

| タイミング | 説明 | 例 |
|------------|------|-----|
| **タスクグループ完了時** | 関連する3-5タスクが完了した時 | 認証関連の5タスクが完了 |
| **大きな設計判断後** | アーキテクチャ決定など、方向性が確定した時 | JWT vs Session の決定完了 |
| **ブロッカー発生時** | Owner の判断待ちになった時 | 外部API契約の承認待ち |

### 優先度 P2（コンテキスト依存）

| コンテキスト使用率 | 対応 |
|-------------------|------|
| **0-70%** | 🟢 通常通り動作 |
| **70-80%** | 🟡 台帳更新を強化、次の区切りを意識 |
| **80-90%** | 🟠 次の論理的区切りでセッション終了を検討 |
| **90-95%** | 🔴 現在のタスク完了後、即座にセッション終了を提案 |
| **95%+** | 🚨 台帳更新して即座にセッション終了（強制） |

---

## セッション終了提案のフォーマット

### 通常のセッション終了提案（70-95%）

```markdown
✅ [完了した作業] が完了しました

📊 セッション状態:
   - コンテキスト使用率: XX%
   - 完了タスク数: N 個
   - 現在のステージ: [STAGE]

📌 次のセッション推奨

**理由**: [機能実装が区切り良く完了した / ゲート通過した / など]

このセッションを終了して、次の作業を新しいセッションで開始することを推奨します。

**メリット**:
- ✅ コンテキストが fresh になり、判断精度が上がる
- ✅ 台帳が整理され、全体像が明確になる
- ✅ 次の作業に集中できる

**次のセッションでやること**:
- [具体的な次のタスク]

---

**[A] 新しいセッションを開始（推奨）**
   → 台帳を更新して終了します
   → 次のチャットで `/org-tick` を実行してください

**[B] このセッションを継続**
   → このまま次のタスクに進みます
   → コンテキスト使用率が高くなったら強制終了の可能性あり

どちらにしますか？
```

### 95%超の場合（強制終了）

```markdown
⚠️ コンテキスト使用率: 95%

自動圧縮を回避するため、このセッションを終了します。

実行中:
1. ✅ DECISIONS.md に今セッションの判断を記録
2. ✅ TASKS.yaml を最新状態に更新
3. ✅ DASHBOARD.md に次のアクションを記載

📌 次のセッションを開始してください

新しいチャットで以下を入力:
→ /org-tick

**次のセッションでやること**:
- [具体的な次のタスク]

台帳から自動的に継続します。
```

---

## 100%を超えて自動圧縮されるのは避ける

**重要: 自動圧縮を待ってはいけない**

Claude Code の自動要約が起きると：
- 重要な技術的文脈が失われる可能性
- OrgOS の台帳更新タイミングを逃す
- 次セッションでの引き継ぎが不完全になる

**95%到達時に能動的にセッションを終了することで、情報損失を防ぐ。**

| 項目 | 自動圧縮を待つ | 95%で能動的終了（推奨） |
|------|----------------|------------------------|
| **情報の制御** | ❌ Claude 任せ | ✅ Manager が選択 |
| **台帳への記録** | ❌ タイミング逃す | ✅ 確実に記録 |
| **次セッションの準備** | ❌ 不完全 | ✅ 明確な引き継ぎ |
| **Owner の混乱** | 🔴 高い | 🟢 低い |
| **情報の損失** | 🔴 高リスク | 🟢 ゼロ |

---

## 次セッションでの継続

OrgOS では台帳がセッション間のメモリとして機能する：

### 1. 新セッション開始時

以下を読み込んで状況を把握：

| 台帳 | 内容 |
|------|------|
| DASHBOARD.md | 現在の状態 |
| TASKS.yaml | 未完了タスク |
| DECISIONS.md | これまでの判断 |
| STATUS.md | 前セッションの進捗 |

### 2. Owner に確認

「前回から継続します。TASKS.yaml の T-xxx から進めます」

変更があれば OWNER_COMMENTS.md で指示をもらう

### 3. 継続実行

- コンテキストは台帳から復元
- 新しいセッションで fresh start

**台帳があるため、コンテキストをゼロから再構築する必要はない。**

---

## コンテキスト使用率別の対応

### 70%未満（🟢 正常）

- 通常通り動作
- 特別な対応は不要

### 70-80%（🟡 注意）

- 台帳更新を強化
  - DECISIONS.md に重要な判断を記録
  - TASKS.yaml を最新状態に更新
- 次の論理的区切りを意識

### 80-90%（🟠 警戒）

- 次の論理的区切りでセッション終了を検討
- 不要な探索を避ける
- 出力を簡潔にする

### 90-95%（🔴 危険）

- 現在のタスク完了後、即座にセッション終了を提案
- 台帳への記録を優先
- 新規タスクは開始しない

### 95%超（🚨 緊急）

- 台帳更新して即座にセッション終了（強制）
- Owner に通知
- 次セッションでの継続を明示

---

## セッション継続性の保証

台帳がセッション間のメモリとして機能：

```markdown
## 台帳ベースの継続性

| 従来の課題 | OrgOS の解決策 |
|------------|----------------|
| コンテキスト溢れで情報喪失 | 台帳に永続化済み |
| 前の会話を覚えていない | DECISIONS.md に判断記録 |
| 同じ質問を繰り返す | PROJECT.md に要件記録 |
| タスク状態が分からない | TASKS.yaml で管理 |
```

---

## 参考資料

- [.claude/rules/performance.md](performance.md) - パフォーマンスルール
- [.ai/DASHBOARD.md](../../.ai/DASHBOARD.md) - 現在の状況確認
- [.ai/TASKS.yaml](../../.ai/TASKS.yaml) - タスク管理
