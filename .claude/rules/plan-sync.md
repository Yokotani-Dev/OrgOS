# 計画の継続的更新ルール（Plan Sync）

> 計画は固定ではない。進捗に応じて常に更新する。

---

## 原則

```
計画 → 実行 → 学習 → 計画更新 → 実行 → ...
```

**初期計画を完璧に守ることより、現実に適応することが重要。**

計画は「契約」ではなく「現在の最善の見通し」である。

---

## 計画更新のトリガー

以下の状況が発生したら、計画を更新する：

| トリガー | 更新内容 | 対象台帳 |
|----------|----------|----------|
| **課題発生** | 対応タスクを追加 | TASKS.yaml, RISKS.md |
| **新規要件** | スコープ・タスクを追加 | PROJECT.md, TASKS.yaml |
| **要件取り下げ** | タスクを削除/archived | TASKS.yaml |
| **実装中の発見** | 追加タスク、依存関係変更 | TASKS.yaml |
| **見積もり乖離** | タスク分割/統合 | TASKS.yaml |
| **リスク顕在化** | 対策タスクを追加 | TASKS.yaml, RISKS.md |
| **ブロッカー発生** | タスク status 変更 | TASKS.yaml |
| **設計変更** | 依存関係・スコープ変更 | TASKS.yaml, DECISIONS.md |

---

## 更新の記録

計画変更は必ず DECISIONS.md に記録：

### フォーマット

```markdown
## PLAN-UPDATE-XXX: [変更内容の要約] (YYYY-MM-DD)

### 変更内容
- 追加: T-XXX ([タスク名])
- 変更: T-YYY の deps に T-XXX を追加
- 削除: T-ZZZ (理由: 要件変更)

### 理由
[なぜこの変更が必要だったか]

### 影響
[他のタスクへの影響、スケジュールへの影響]

### トリガー
[課題発生 / 新規要件 / など]
```

### 例

```markdown
## PLAN-UPDATE-001: タスク追加 (2026-01-22)

### 変更内容
- 追加: T-FIX-001 (Client Secret 更新)
- 変更: T-004 の deps に T-FIX-001 を追加

### 理由
- ISSUE-005 対応のため
- Client Secret の有効期限切れが判明

### 影響
- T-004 の開始が T-FIX-001 完了後に延期
- ステージング環境へのデプロイが1日遅延

### トリガー
課題発生（ISSUE-005）
```

---

## Tick での計画整合性チェック

毎 Tick で以下をチェック（`/org-tick` の Step 5）：

### 1. 未計画タスクの実行がないか

```
チェック:
  ad-hoc 実行した作業が TASKS.yaml にあるか？

対応:
  なければ TASKS.yaml に追加
  STATUS.md の RUN_LOG から抽出
```

### 2. 課題が計画に反映されているか

```
チェック:
  RISKS.md の新規 ISSUE に対応タスクがあるか？

対応:
  なければ対応タスクを TASKS.yaml に追加
  優先度 P0 で即座に対応
```

### 3. 依存関係に矛盾がないか

```
チェック:
  未完了の deps を持つタスクが running していないか？

対応:
  あれば status を blocked に変更
  blocker フィールドに deps を記録
```

### 4. スコープクリープがないか

```
チェック:
  PROJECT.md にない機能が実装されていないか？

対応:
  あれば Owner に確認
  スコープ拡張 or タスク削除を判断
```

### 5. 見積もり乖離の検出

```
チェック:
  予想より時間がかかっているタスクはないか？

対応:
  あればタスク分割を検討
  または技術的課題として RISKS.md に記録
```

---

## ❌ やってはいけないこと

```
❌ 課題が発生しても計画を更新しない
   → 計画と実態が乖離し、追跡不能になる
   → 後から「何が起きたか」が分からなくなる

❌ ad-hoc 作業を記録しない
   → 何が行われたか分からなくなる
   → 同じ問題に再度遭遇する

❌ 初期計画に固執する
   → 現実に適応できず、プロジェクトが破綻する
   → 「計画通りに進めること」が目的化する

❌ 計画変更を Owner に報告しない
   → Owner が現状を把握できない
   → 期待とのズレが生じる
```

---

## ✅ 正しい運用

```
✅ 課題発生 → 即座に TASKS.yaml に追加
   → 対応タスクを作成
   → DECISIONS.md に PLAN-UPDATE-XXX として記録

✅ ad-hoc 作業 → RUN_LOG + 必要なら TASKS.yaml に追加
   → 小タスクでも記録を残す
   → 後から追跡可能にする

✅ 計画変更 → DECISIONS.md に理由を記録
   → なぜ変更したかを明確にする
   → Owner に変更内容を報告

✅ 毎 Tick で整合性チェック → 乖離があれば修正
   → 計画と実態を常に一致させる
   → 問題を早期に発見
```

---

## 計画更新の例

### 例1: 課題発生による追加

```yaml
# 元の計画（TASKS.yaml）
- id: T-004
  title: "ステージング環境にデプロイ"
  status: queued
  deps: [T-003]

# 課題発生: Client Secret 有効期限切れ

# 更新後の計画
- id: T-FIX-001
  title: "Client Secret 更新"
  status: queued
  priority: P0
  deps: []

- id: T-004
  title: "ステージング環境にデプロイ"
  status: queued
  deps: [T-003, T-FIX-001]  # 依存関係追加
```

```markdown
# DECISIONS.md に記録
## PLAN-UPDATE-001: Client Secret 更新タスク追加 (2026-01-22)

### 変更内容
- 追加: T-FIX-001 (Client Secret 更新)
- 変更: T-004 の deps に T-FIX-001 を追加

### 理由
デプロイ前の動作確認で Client Secret の有効期限切れが判明。
デプロイ前に更新が必要。

### 影響
T-004 の開始が1日延期。

### トリガー
課題発生（ISSUE-005）
```

### 例2: 実装中の発見による分割

```yaml
# 元の計画
- id: T-003
  title: "認証機能の実装"
  status: in_progress

# 実装中の発見: JWT と Session の設計判断が必要

# 更新後の計画
- id: T-003-1
  title: "認証方式の設計判断"
  status: in_progress
  deps: []

- id: T-003-2
  title: "JWT 認証の実装"
  status: queued
  deps: [T-003-1]

- id: T-003-3
  title: "認証ミドルウェアの実装"
  status: queued
  deps: [T-003-2]

- id: T-003
  title: "認証機能の実装"
  status: archived
  notes: "T-003-1, T-003-2, T-003-3 に分割"
```

```markdown
# DECISIONS.md に記録
## PLAN-UPDATE-002: 認証タスクの分割 (2026-01-22)

### 変更内容
- T-003 を3つのサブタスクに分割
  - T-003-1: 認証方式の設計判断
  - T-003-2: JWT 認証の実装
  - T-003-3: 認証ミドルウェアの実装
- T-003 を archived に変更

### 理由
実装開始後、認証方式の設計判断が必要と判明。
設計 → 実装 → ミドルウェアの順に分割することで、
各ステップを明確にし、レビューしやすくする。

### 影響
タスク数が増えたが、全体の工数は変わらず。
各タスクが小さくなり、進捗が可視化される。

### トリガー
実装中の発見
```

---

## 計画更新の頻度

| 状況 | 更新タイミング |
|------|--------------|
| 課題発生 | 即座（その Tick で） |
| 新規要件 | Owner 確認後、即座に |
| 実装中の発見 | 発見時点で |
| 見積もり乖離 | 乖離が明確になった時点で |
| 依存関係変更 | 変更が必要と判明した時点で |

**「後で更新する」は禁止。必ず即座に更新する。**

---

## 参考資料

- [.ai/TASKS.yaml](../../.ai/TASKS.yaml) - タスク管理
- [.ai/DECISIONS.md](../../.ai/DECISIONS.md) - 判断記録
- [.ai/RISKS.md](../../.ai/RISKS.md) - リスク管理
- [.claude/rules/project-flow.md](project-flow.md) - プロジェクトフロー
