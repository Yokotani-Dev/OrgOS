# プロジェクトフロールール

> OrgOS フローの優先、スコープ制限、タスク規模判定

---

## 最優先ルール：OrgOS フロー優先

**新規セッションでも、スラッシュコマンド以外の依頼でも、必ず OrgOS フローで処理する。**

### セッション開始時の行動

1. **まず `.ai/TASKS.yaml` を確認する**
   - 進行中のプロジェクトがあるか？
   - 現在のフェーズは？
   - 未完了タスクは？

2. **依頼を OrgOS タスクとして認識する**
   - Claude Code のネイティブ Plan モード（EnterPlanMode）は**使用しない**
   - 代わりに `.ai/TASKS.yaml` に追加して管理する

3. **既存プロジェクトがある場合**
   - 依頼が既存タスクに関連するか判断
   - 関連あり → 該当タスクの一部として処理
   - 関連なし → 新規タスクとして追加

### EnterPlanMode を使わない理由

| Claude Code Plan モード | OrgOS フロー |
|------------------------|--------------|
| セッション内で完結 | 永続化（TASKS.yaml） |
| 履歴が残らない | DECISIONS.md に記録 |
| 他セッションと連携不可 | どのセッションからも参照可能 |

### 例外

以下の場合のみ OrgOS フロー外で対応してよい：

- OrgOS 自体についての質問（「OrgOS って何？」など）
- 単発の情報提供（「TypeScript の型の書き方教えて」など）
- プロジェクトと無関係な雑談

---

## プロジェクトスコープ制限

**このリポジトリが OrgOS 開発用の場合、OrgOS と無関係な依頼は受け付けない。**

### スコープ確認

依頼を受けたら、まず `CONTROL.yaml` の `project_scope` を確認:

```yaml
project_scope: "OrgOS development only"  # OrgOS 開発ディレクトリの場合
```

### スコープ内の判定基準

| 依頼 | 判定 |
|------|------|
| OrgOS の機能追加・修正 | ✅ スコープ内 |
| OrgOS のドキュメント更新 | ✅ スコープ内 |
| OrgOS の改善提案（OIP） | ✅ スコープ内 |
| OrgOS を使った別プロジェクト開発 | ❌ スコープ外 |
| Azure Function など別システムの診断 | ❌ スコープ外 |
| 一般的なプログラミング質問 | 🟡 単発ならOK |

### スコープ外の依頼を受けた場合

**必ず Owner に確認する:**

```
⚠️ スコープ外の依頼を検出しました

依頼内容: 「[依頼内容]」
このリポジトリのスコープ: 「OrgOS development only」

以下のいずれかを選んでください:

[A] 別のディレクトリで作業する
    → OrgOS と無関係なプロジェクトは別ディレクトリで管理することを推奨

[B] OrgOS の改善として扱う
    → この依頼が OrgOS に関連する場合のみ（例: OrgOS の機能追加）

[C] スコープを一時的に拡張する
    → CONTROL.yaml の project_scope を更新（推奨しない）

どれにしますか？
```

**Owner 承認なしに進めてはいけない。**

---

## タスク規模の判定

### 最重要ルール: 全作業 TASKS.yaml 登録必須

**規模に関わらず、全ての作業を TASKS.yaml に登録してから実行する。**
ad-hoc 実行（TASKS.yaml を経由せず直接作業すること）は禁止。

```
❌ 禁止: 依頼を受けてそのまま実行する
✅ 必須: 依頼 → TASKS.yaml に登録 → 実行 → 完了記録
```

### 依頼受付時の必須チェック（重要）

依頼を受けたら、**以下を必ず実行:**

```
1. ✅ プロジェクトスコープ確認
   - CONTROL.yaml の project_scope を確認
   - スコープ外なら Owner に確認（即実行禁止）

2. ✅ タスク規模を判定
   - 小: 1ファイル、他に影響なし
   - 中: 複数ファイル、設計判断あり
   - 大: 新機能、アーキテクチャ変更

3. ✅ TASKS.yaml に登録（全規模共通）
   - 小タスクでも必ず登録する
   - deps を設定する（進行中タスクとの関係を明確化）
   - 登録完了後に実行

4. ✅ 台帳を更新
   - TASKS.yaml: タスク追加
   - 中〜大: DECISIONS.md に PLAN-UPDATE-XXX として記録
   - STATUS.md / DASHBOARD.md: 更新
```

### 判断基準

| 規模 | 基準 | 対応 |
|------|------|------|
| 小 | 1ファイル以内、他タスクに影響なし | TASKS.yaml 登録 → 同一 Tick 内で実行 → done |
| 中 | 複数ファイル or 設計判断あり | TASKS.yaml 登録 + DECISIONS.md 記録 → 次 Tick で実行 |
| 大 | 新機能、アーキテクチャ変更 | PROJECT/BRIEF から計画 |

### 小タスクの処理

```
1. TASKS.yaml に登録（status: queued, deps 設定）
2. 同一 Tick 内で実行
3. TASKS.yaml を done に更新
4. STATUS.md の RUN_LOG に記録
5. 完了報告 + 次のステップ案内
```

### 中〜大タスクの処理

```
1. 「計画に組み込みます」と説明
2. TASKS.yaml に追加（deps で他タスクとの関係を明示）
3. DECISIONS.md に PLAN-UPDATE-XXX として記録
4. /org-tick で実行を案内
```

### 例

```
User: 「このファイルにログ出力追加して」

Manager:
  → 小タスクと判定
  → TASKS.yaml に T-FIX-XXX として登録（status: queued）
  → 実行 → done に更新
  → STATUS.md に記録
  → 完了報告 + 次のステップ案内
```

```
User: 「認証機能をJWTに変更して」

Manager:
  → 大タスクと判定
  → 「計画に組み込みます」と説明
  → TASKS.yaml に追加、deps で既存タスクとの関係を設定
  → DECISIONS.md に PLAN-UPDATE-XXX 記録
  → /org-tick で実行を案内
```

---

## 割り込みタスク受付フロー

**進行中のタスクがある状態で新しい依頼を受けた場合のフロー。**

### 原則

```
新しい依頼は、進行中タスクを中断せずに並列管理する。
TASKS.yaml の DAG で依存関係を明示し、衝突を防ぐ。
```

### フロー

```
1. 新しい依頼を受ける

2. 既存タスクとの関係を判断
   - 独立（同じファイルを触らない） → deps: [] で並列実行可能
   - 依存あり（同じファイルを触る） → deps に既存タスクを設定
   - 既存タスクの一部 → 既存タスクの notes に追記、または subtask として追加

3. TASKS.yaml に登録
   - 新しい ID を採番
   - deps を正しく設定
   - allowed_paths で衝突しないことを確認

4. 実行タイミングを決定
   - 小タスク + 独立 → 同一 Tick で即実行
   - 中〜大タスク or 依存あり → 次の Tick で実行
```

### 衝突防止

```
allowed_paths が重複する場合:
  → 後から来たタスクの deps に先行タスクを追加
  → 「T-XXX 完了後に実行します」と Owner に説明

allowed_paths が重複しない場合:
  → 並列実行可能
  → 「T-YYY と並行して進めます」と Owner に説明
```

### 例

```
状況: T-INT-005（ロールバック機構）が running

User: 「org-tick のレビュー設定が効いてないんだけど」

Manager:
  → 新しい依頼を認識
  → T-INT-005 と独立（allowed_paths が重複しない）
  → TASKS.yaml に T-OS-XXX として登録（deps: []）
  → 「T-INT-005 と並行して進めます」
  → 同一 Tick 内で実行 → done
```

---

## スラッシュコマンド以外の依頼への対応

### 原則

**個別のプロンプトも OrgOS の制御下に取り込む。全ての作業を TASKS.yaml 経由で管理する。**

ユーザーがスラッシュコマンドを使わずに依頼してきた場合：

1. **スコープ確認**
   - CONTROL.yaml の `project_scope` を確認
   - スコープ外なら Owner に確認

2. **タスクとして認識する**
   - 「これは何をする依頼か」を明確にする

3. **TASKS.yaml に登録する（規模問わず）**
   - 小タスクでも必ず TASKS.yaml に登録
   - 進行中タスクがあれば deps を設定（割り込みタスク受付フロー参照）

4. **実行する**
   - 小タスク → 同一 Tick 内で実行可能
   - 中〜大タスク → 次の Tick で実行

5. **完了後は OrgOS フローに戻る**
   - TASKS.yaml を done に更新
   - STATUS.md の RUN_LOG に記録
   - 次に何をすべきか案内する

---

## 参考資料

- [CLAUDE.md](../../CLAUDE.md)
- [.ai/CONTROL.yaml](../../.ai/CONTROL.yaml)
- [.ai/TASKS.yaml](../../.ai/TASKS.yaml)
