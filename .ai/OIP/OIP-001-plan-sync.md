# OIP-001: Plan Sync 強化（依頼を必ず全体計画に組み込む）

> Status: Draft
> Created: 2026-01-23
> Author: Manager

---

## 問題

**Manager が依頼を受けても TASKS.yaml に追加せず、ad-hoc 作業になってしまう。**

### 症状

- スラッシュコマンド以外の依頼を受けた際、TASKS.yaml に追加せずに直接作業を開始
- 次のステップ案内は出すが、全体計画との整合性が不明
- 台帳が更新されないため、他セッションから参照不可
- 「普通の Claude Code」と変わらない動作になる

### 根本原因

CLAUDE.md にルールは書いてあるが、**Manager が実際には守っていない**。

```markdown
### スラッシュコマンド以外の依頼を受けたとき

2. **規模に応じて対応を選ぶ**
   - 小さいタスク（数分で完了、他に影響なし）→ その場で実行し、RUN_LOGに記録
   - **中〜大のタスク**（複数ファイル変更、設計判断あり）→ **TASKS.yaml に追加して計画に組み込む**
```

しかし、実際には中〜大のタスクでも TASKS.yaml に追加されない。

---

## 提案

### 1. CLAUDE.md の強化

**依頼受付時の自動判断ルールを明確化:**

```markdown
## 依頼受付時の必須チェック

依頼を受けたら、以下を必ず実行:

1. **タスク規模を判定**
   - 小: 1ファイル、5分以内、他に影響なし → 即実行 + RUN_LOG記録
   - 中: 複数ファイル、設計判断あり → TASKS.yaml 追加
   - 大: 新機能、アーキテクチャ変更 → PROJECT/BRIEF から計画

2. **中〜大タスクの場合**
   ```
   ❌ 即実行してはいけない
   ✅ TASKS.yaml に追加してから実行
   ```

3. **台帳更新**
   - TASKS.yaml: タスク追加
   - DECISIONS.md: PLAN-UPDATE-XXX として記録
   - STATUS.md / DASHBOARD.md: 更新

4. **次のステップ案内に台帳参照を含める**
   ```
   📌 次はこちら: T-XXX を実行します
      全体計画: .ai/TASKS.yaml を参照
      進捗状況: .ai/STATUS.md を参照
   ```
```

### 2. /org-tick に Plan Sync チェックを追加

**Tick 実行時に整合性をチェック:**

```yaml
# Step 5: Plan Sync チェック
- 未計画タスクの実行がないか確認
  - ad-hoc 実行した作業は TASKS.yaml に追加
- 課題が計画に反映されているか確認
  - 新規 ISSUE → 対応タスクを追加
- 依存関係に矛盾がないか確認
```

### 3. プロジェクトスコープの制限（新規）

**OrgOS リポジトリでは OrgOS 開発のみ受け付ける:**

```yaml
# CONTROL.yaml に追加
project_scope: "OrgOS development only"
```

```markdown
# CLAUDE.md に追加

## プロジェクトスコープ制限

このリポジトリは OrgOS 自体の開発用です。

**スコープ外の依頼を検出した場合:**

1. **確認する**
   ```
   ⚠️ スコープ外の依頼を検出しました

   依頼内容: 「Azure Function の診断」
   このリポジトリのスコープ: 「OrgOS 開発」

   以下のいずれかを選んでください:
   [A] 別のディレクトリで作業する
   [B] OrgOS の改善として扱う（OrgOS に関連する場合のみ）
   [C] スコープを一時的に拡張する（CONTROL.yaml を更新）
   ```

2. **Owner 承認なしに進めない**

**スコープ内の判定基準:**

| 依頼 | 判定 |
|------|------|
| OrgOS の機能追加・修正 | ✅ スコープ内 |
| OrgOS のドキュメント更新 | ✅ スコープ内 |
| OrgOS を使った別プロジェクト開発 | ❌ スコープ外 |
| Azure Function など別システムの診断 | ❌ スコープ外 |
```

---

## 期待される効果

- ✅ 全ての作業が TASKS.yaml で管理される
- ✅ 他セッションから進捗が追跡可能
- ✅ 計画と実態の乖離がなくなる
- ✅ OrgOS らしい動作になる
- ✅ スコープ外の作業を誤って始めない

---

## 実装タスク

- [x] CLAUDE.md に「依頼受付時の必須チェック」を追加
- [x] CLAUDE.md に「プロジェクトスコープ制限」を追加
- [x] CONTROL.yaml に `project_scope` を追加
- [x] /org-tick に Plan Sync チェックを追加（Step 6 に ad-hoc 作業・スコープ外作業の検出を追加）
- [ ] テスト: スコープ外の依頼で確認が出るか

---

## 参考

- CLAUDE.md: スラッシュコマンド以外の依頼を受けたとき
- CLAUDE.md: 計画の継続的更新（Plan Sync）
