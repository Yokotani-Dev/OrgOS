# Task DAG (SSOT)
# status: queued | running | blocked | review | done
#
# owner_role の選択肢:
#   - org-planner      : 要件整理（Claude subagent）
#   - org-architect    : 設計・Contract定義（Claude subagent）
#   - codex-implementer: 実装（Codex worker）★推奨
#   - codex-reviewer   : レビュー（Codex worker）★推奨
#   - org-integrator   : 統合・マージ（Claude subagent）
#   - org-scribe       : 台帳整理（Claude subagent）
#
# ※ org-implementer / org-reviewer は非推奨（Codex に移行済み）

tasks:
  - id: T-001
    title: "Kickoff: collect requirements"
    status: queued
    deps: []
    owner_role: "org-planner"
    allowed_paths: [".ai/"]
    acceptance:
      - "PROJECT.md populated"
      - "DECISIONS.md has pending list"
    notes: ""

  - id: T-002
    title: "Design: define contracts (API/schema)"
    status: queued
    deps: ["T-001"]
    owner_role: "org-architect"
    allowed_paths: ["docs/", "src/"]
    acceptance:
      - "contracts documented"
    notes: ""

  # === OrgOS 改善タスク ===

  - id: T-OS-001
    title: "セッション間メモリ永続化（Stop フック + sessions フォルダ）"
    status: done
    deps: []
    owner_role: "org-implementer"  # 歴史的記録（当時は org-implementer を使用）
    allowed_paths: [".claude/hooks/", ".ai/sessions/", ".ai/LEARNED/"]
    acceptance:
      - "Stop フックがセッション学習を抽出・保存"
      - ".ai/sessions/ に日次ログが生成される"
      - "SessionStart で前回の学びをロード"
    notes: "記事参照: PreCompact + Stop + SessionStart パターン"

  - id: T-OS-002
    title: "継続学習スキル（/org-learn コマンド）"
    status: done
    deps: ["T-OS-001"]
    owner_role: "org-implementer"  # 歴史的記録（当時は org-implementer を使用）
    allowed_paths: [".claude/commands/", ".claude/skills/learned/"]
    acceptance:
      - "/org-learn コマンドが動作する"
      - "パターンが .claude/skills/learned/ に保存される"
      - "次回セッションで自動参照される"
    notes: "記事参照: Continuous Learning Skill"

  - id: T-OS-003
    title: "評価ループ（CONTROL.yaml 拡張 + 評価ポリシー）"
    status: done
    deps: []
    owner_role: "org-implementer"  # 歴史的記録（当時は org-implementer を使用）
    allowed_paths: [".ai/CONTROL.yaml", ".claude/rules/", "CLAUDE.md"]
    acceptance:
      - "CONTROL.yaml に eval_policy セクション追加"
      - "チェックポイント評価が /org-tick で動作"
      - "評価結果が DECISIONS.md に記録される"
    notes: "記事参照: Verification Loops and Evals"

  - id: T-OS-004
    title: "上司レビューモード（スーパーバイザーレビュー機能）"
    status: done
    deps: []
    owner_role: "codex-implementer"
    allowed_paths: [".ai/", ".claude/commands/", ".claude/rules/", "CLAUDE.md"]
    acceptance:
      - "/org-start で「作業者」「上司レビュー要否」を質問"
      - "CONTROL.yaml に supervisor_review セクション追加"
      - "重要な判断時にレビュードキュメント自動生成（.ai/SUPERVISOR_REVIEW/）"
      - "計画乖離を自動検知（BRIEF.md とのずれ）"
      - "レビュー承認待ち状態で停止する仕組み"
    notes: |
      3つのモード:
      1. 自分 + レビューあり（重要な判断で上司レビューをリマインド）
      2. 自分のみ（上司レビューなし）
      3. 部下 + スーパーバイザー（部下が作業、上司レビュー必須）

  - id: T-OS-005
    title: "プロジェクト引き継ぎ機能"
    status: done
    deps: ["T-OS-004"]
    owner_role: "codex-implementer"
    allowed_paths: [".ai/", ".claude/commands/", ".claude/hooks/", "CLAUDE.md"]
    acceptance:
      - "CONTROL.yaml に handoff セクション追加"
      - "引き継ぎドキュメント（.ai/HANDOFF.md）自動生成"
      - "SessionStart フックで引き継ぎ検知"
      - "引き継ぎ時の注意事項を表示"
    notes: |
      引き継ぎパターン:
      - 上司が BRIEF → 要件定義 → git push
      - 部下が git pull → /org-tick で続きから作業
      - 引き継ぎ情報（誰から誰へ、どこまで完了、注意事項）を記録

  - id: T-OS-006
    title: "ゴール階層管理・動的計画再構築機能"
    status: done
    deps: []
    owner_role: "codex-implementer"
    allowed_paths: [".ai/", ".claude/commands/", ".claude/rules/", "CLAUDE.md"]
    acceptance:
      - ".ai/GOALS.yaml 新規作成（Vision/Milestone/Project 階層管理）"
      - "/org-start で GOALS.yaml 自動生成（BRIEF.md から Vision 抽出）"
      - "/org-tick で Milestone 達成確認・見直し提案"
      - "/org-goals コマンド作成（ゴール可視化・編集）"
      - "DASHBOARD.md に Vision/Milestone 表示"
      - "新規依頼の位置づけ自動判断（Vision/Milestone/Project/Task）"
      - "GOALS.yaml history にゴール変更履歴を記録"
    notes: |
      OIP-006 参照。
      ユーザーの依頼に応じてゴールを再構造化し、全体整合のある計画を維持。
      Vision → Milestone → Project → Task の4階層で管理。
      Milestone 達成時・新規依頼が乖離時・20タスク完了ごとに見直し提案。

  - id: T-OS-007
    title: "成果物管理機能（outputs/ フォルダ構造 + 資料複製ルール）"
    status: done
    deps: []
    owner_role: "codex-implementer"
    allowed_paths: ["outputs/", ".gitignore", "CLAUDE.md", ".claude/agents/AGENTS.md", ".claude/rules/"]
    acceptance:
      - "outputs/ フォルダ構造の設計・実装（日付別 + タスクID別）"
      - ".gitignore に outputs/ の扱いを追加"
      - "CLAUDE.md に成果物管理ルールを追加"
      - "AGENTS.md（Codex worker）に資料複製→outputs/ 配置のフローを追加"
      - "outputs/README.md 作成（フォルダ説明）"
    notes: |
      Owner依頼: 成果物を資料（samplecode など）から分離して outputs/ に格納。
      資料は直接編集せず、複製して outputs/ に配置。

      構造例:
      outputs/
      ├── 2026-01-23/       # 日付別
      │   ├── sample1.ts
      │   └── README.md
      └── T-OS-004/         # タスクID別
          └── implementation.ts

      .gitignore: outputs/ を管理対象にするか Owner に確認（デフォルト: 管理する）

  # === 上司FB対応タスク (2026-01-28) ===

  - id: T-OS-008
    title: "/org-start で README.md をプロジェクト用に置換する仕組み"
    status: done
    deps: []
    owner_role: "codex-implementer"
    allowed_paths: ["README.md", ".claude/commands/org-start.md", ".ai/TEMPLATES/"]
    acceptance:
      - "/org-start 実行時に README.md をプロジェクト用テンプレに置換"
      - "OrgOS の README は ORGOS_README.md 等にリネーム保持"
    notes: "上司FB#1: GitHub冒頭のREADMEがOrgOSのREADMEになっている"

  - id: T-OS-009
    title: "生成物フォルダ位置の安定化（outputs/ ルール強化）"
    status: done
    deps: []
    owner_role: "codex-implementer"
    allowed_paths: [".claude/rules/", ".claude/agents/", "CLAUDE.md", "outputs/"]
    acceptance:
      - "生成物の配置先ルールを明確化（outputs/ 直下 or サブフォルダ）"
      - "エージェントが生成物を正しい場所に配置する検証"
    notes: "上司FB#2: 生成物のフォルダ位置が不安定"

  - id: T-OS-010
    title: "設計フェーズで自動的にドキュメント生成タスクをバックログする仕組み"
    status: done
    deps: []
    owner_role: "codex-implementer"
    allowed_paths: [".claude/commands/", ".claude/rules/", ".claude/agents/"]
    acceptance:
      - "DESIGN ステージ遷移時に設計ドキュメント作成タスクを自動追加"
      - "ドキュメント生成を主体的に進める org-tick ロジック"
    notes: "上司FB#3: 設計のドキュメント作成をもっと主体的にバックログして進めてほしい"

  - id: T-OS-011
    title: "設計フェーズでの最新情報自動取得スキル（WebSearch/DeepResearch連携）"
    status: done
    deps: []
    owner_role: "codex-implementer"
    allowed_paths: [".claude/skills/", ".claude/rules/", ".claude/agents/"]
    acceptance:
      - "設計フェーズ開始時に WebSearch で最新技術情報を自動収集"
      - "収集結果を .ai/RESOURCES/ に保存"
      - "設計判断時に最新情報を参照する仕組み"
    notes: |
      上司FB#4/#5: 最新情報を持っていない、設計時に情報が古い
      DeepResearch を別途かけている現状を解消する
      モデル選定にはベンチマークサイト参照も検討

  - id: T-OS-012
    title: "日付認識の強化（SessionStart での日付注入 + 制約ルール）"
    status: done
    deps: []
    owner_role: "codex-implementer"
    allowed_paths: [".claude/hooks/", ".claude/rules/", "CLAUDE.md"]
    acceptance:
      - "SessionStart hook で現在日付を明示的に注入"
      - "日付出力時に必ず現在日付を参照するルール追加"
      - "2024年等の誤出力を防止"
    notes: "上司FB#6: 今日がいつか分かっていない、24年と出してくる"

  - id: T-OS-013
    title: "git clone 時のフォルダ入れ子問題の改善"
    status: done
    deps: []
    owner_role: "codex-implementer"
    allowed_paths: ["README.md", "ORGOS_QUICKSTART.md"]
    acceptance:
      - "clone コマンドの案内を改善（. 指定で中身だけ展開）"
      - "セットアップスクリプト or 手順の明確化"
    notes: |
      上司FB#7: フォルダの中にOrgOSフォルダができて入れ子になる
      git clone URL . で解決可能だが案内を改善

  # === Codex CLI 統合 (OIP-008) ===

  - id: T-OS-014
    title: "Codex CLI 統合 Phase 1: 検証（codex exec での実装品質検証）"
    status: done
    deps: []
    owner_role: "org-architect"
    allowed_paths: [".claude/agents/", ".claude/rules/", ".ai/"]
    acceptance:
      - "codex exec で小タスクを実行し、品質を検証"
      - "Work Order → codex exec のパイプラインが動作"
      - "検証結果を DECISIONS.md に記録"
    notes: |
      OIP-008 Phase 1 完了（2026-01-28）
      検証結果:
      - read-only/workspace-write 両モード正常動作
      - デフォルトモデル: gpt-5.2-codex（ChatGPT 最上位プランで利用可能）
      - -m codex-5.2 / -m o3 は ChatGPT アカウントでは使用不可
      - 日本語プロンプト正常動作
      - Bash 経由で prompt を渡すパイプラインが動作確認済み

  - id: T-OS-015
    title: "Codex CLI 統合 Phase 2: org-implementer に Codex CLI 呼び出しを追加"
    status: done
    deps: ["T-OS-014"]
    owner_role: "codex-implementer"
    allowed_paths: [".claude/agents/", ".claude/rules/", ".claude/commands/"]
    acceptance:
      - "org-implementer が Codex CLI を呼び出して実装を実行"
      - "CONTROL.yaml の codex.auto_exec フラグで制御"
      - "レビューフローと統合"
    notes: |
      OIP-008 Phase 2 完了（2026-01-28）
      変更内容:
      - org-tick.md Step 8.2.1: auto_exec: true 時の自動実行フロー追加
      - agent-coordination.md: Codex CLI 実行パターン・役割分担表を追加
      - run-parallel.sh: タスクID正規表現を ^T- に修正（T-OS-xxx 対応）
      - Work Order テンプレート生成済み（.ai/CODEX/ORDERS/T-OS-015.md）

  # === OrgOS 構成最適化 (2026-01-28) ===

  - id: T-OS-016
    title: "OrgOS 構成リファクタリング（冗長性削減 ~850行）"
    status: done
    deps: []
    owner_role: "codex-implementer"
    allowed_paths: ["CLAUDE.md", ".claude/rules/", ".claude/skills/", ".claude/agents/", ".claude/commands/", "AGENTS.md", "requirements.md"]
    acceptance:
      - "CLAUDE.md を 390行 → ~80行に圧縮（原則要約 + 参照リストのみ）"
      - "patterns.md を廃止し skills/ に統合（または目次化）"
      - "選択肢提示ルールを next-step-guidance.md に一元化"
      - "コンテキスト使用率テーブルを session-management.md に一元化"
      - "セキュリティコード例を security.md に一元化"
      - "requirements.md に歴史的文書宣言を追加"
      - "既存の動作が壊れないこと（全ルール・コマンドが正しく参照解決）"
    notes: |
      コードレビュー結果に基づくリファクタリング。
      主な重複箇所:
      1. CLAUDE.md ↔ manager.md / project-flow.md (~150行)
      2. patterns.md ↔ skills/ (~300行)
      3. ai-driven-development.md ↔ next-step-guidance.md (~80行)
      4. コンテキスト使用率テーブル 3箇所 (~60行)
      5. セキュリティコード例 3箇所 (~100行)
      サブタスク分割は実行時に検討。

  - id: T-OS-017
    title: "Codex Worker が .claude/ ルール群を参照できる仕組み"
    status: done
    deps: []
    owner_role: "codex-implementer"
    allowed_paths: ["AGENTS.md", ".claude/agents/AGENTS.md", ".ai/CODEX/"]
    acceptance:
      - "AGENTS.md に .claude/rules/ と .claude/skills/ の参照ガイドを追加"
      - "Work Order テンプレートに参照すべきルール/スキルの明示セクションを強化"
      - "Codex Worker が実装・レビュー時に適切なルールを参照できること"
    notes: |
      現状: AGENTS.md は review-criteria.md と security.md のみ参照。
      追加すべき参照:
      - .claude/rules/patterns.md（→ T-OS-016 後は skills/ を直接参照）
      - .claude/skills/coding-standards.md
      - .claude/skills/backend-patterns.md
      - .claude/skills/frontend-patterns.md
      - .claude/skills/tdd-workflow.md
      - .claude/rules/testing.md
      Work Order 生成時に、タスク種別に応じた参照ファイルリストを自動付与する。

  # === 全体コードレビュー (2026-01-30) ===

  - id: T-OS-018
    title: "OrgOS 全体コードレビュー（品質改善）"
    status: done
    deps: []
    owner_role: "org-reviewer"
    allowed_paths: [".claude/", ".ai/"]
    acceptance:
      - ".claude/rules/ 全ファイルレビュー完了"
      - ".claude/skills/ 全ファイルレビュー完了"
      - ".claude/agents/ 全ファイルレビュー完了"
      - ".claude/commands/ 全ファイルレビュー完了"
      - ".ai/ 台帳・設定ファイルレビュー完了"
      - "問題点を CRITICAL/HIGH/MEDIUM/LOW で分類"
      - "改善提案を具体的に提示"
    notes: |
      BRIEF.md 参照。品質改善目的の全体レビュー。
      修正は別タスクとして計画（このタスクでは修正しない）。

  # === レビュー指摘修正タスク (2026-01-30) ===

  - id: T-OS-019
    title: "レビュー指摘修正 P0: 壊れた参照パス修正 + 関数サイズ基準統一"
    status: done
    deps: []
    owner_role: "codex-implementer"
    allowed_paths: [".claude/rules/", ".claude/skills/"]
    acceptance:
      - "testing.md L232 の参照パスを修正"
      - "関数サイズ基準を統一（coding-standards.md: 20行推奨 / review-criteria.md: 50行上限）"
    notes: |
      T-OS-018 レビュー結果: CRITICAL 1件 + HIGH 1件

  - id: T-OS-020
    title: "レビュー指摘修正 P1: rules/ 間の重複排除"
    status: done
    deps: ["T-OS-019"]
    owner_role: "codex-implementer"
    allowed_paths: [".claude/rules/"]
    acceptance:
      - "モデル選択ガイダンスを agent-coordination.md に一元化"
      - "コンテキスト管理を session-management.md に一元化"
      - "応答末尾チェックリストを next-step-guidance.md に一元化"
    notes: |
      T-OS-018 レビュー結果: HIGH 3件（重複排除）

  - id: T-OS-021
    title: "レビュー指摘修正 P2: エージェント定義の補完・整理"
    status: done
    deps: ["T-OS-019"]
    owner_role: "codex-implementer"
    allowed_paths: [".claude/agents/"]
    acceptance:
      - "org-integrator.md を拡充（役割・手順・判断基準を追加）"
      - "org-os-maintainer.md を拡充"
      - "org-implementer.md を削除（DEPRECATED済み）"
      - "AGENTS.md を CODEX_WORKER_GUIDE.md にリネーム"
    notes: |
      T-OS-018 レビュー結果: HIGH 2件 + MEDIUM 2件

  - id: T-OS-022
    title: "レビュー指摘修正 P3: commands/ 重複集約 + 台帳整理"
    status: queued
    deps: ["T-OS-020"]
    owner_role: "codex-implementer"
    allowed_paths: [".claude/commands/", ".ai/"]
    acceptance:
      - "org-tick.md の Codex CLI チェックを共通セクションに集約"
      - "patterns.md を削除（CLAUDE.md から直接 skills/ を参照）"
      - "DASHBOARD.md のゲート制御テーブルを実態と一致させる"
      - "TASKS.yaml の deprecated org-implementer ロール参照を修正"
    notes: |
      T-OS-018 レビュー結果: HIGH 2件 + MEDIUM 6件

  # === 以下はCodex workerを使う実装タスクの例 ===
  # - id: T-003
  #   title: "Implement: user authentication module"
  #   status: queued
  #   deps: ["T-002"]
  #   owner_role: "codex-implementer"  # ← Codex worker
  #   allowed_paths: ["src/auth/", "tests/auth/"]
  #   acceptance:
  #     - "login/logout implemented"
  #     - "tests pass"
  #   notes: ""
